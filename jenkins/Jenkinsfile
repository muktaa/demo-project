pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-deployer
  containers:
  - name: aws-kubectl
    image: amazon/aws-cli:latest
    command: ['sleep', '3600']
"""
        }
    }

    stages {
        stage('Setup Tools') {
            steps {
                container('aws-kubectl') {
                    sh '''
                        curl -LO https://dl.k8s.io/release/v1.24.0/bin/linux/amd64/kubectl
                        chmod +x kubectl && mv kubectl /usr/local/bin/
                        kubectl version --client
                    '''
                }
            }
        }
        
        stage('Deploy to EKS') {
            steps {
                container('aws-kubectl') {
                    sh '''
                        echo "=== Configuring EKS ==="
                        aws eks update-kubeconfig --region ap-south-1 --name last9-demo

                        echo "=== Applying resources ==="
                        kubectl apply -f k8s/

                        echo "=== Checking pods ==="
                        kubectl get pods -n last9-otel-demo
                        
                        echo "=== Checking services ==="
                        kubectl get services -n last9-otel-demo
                    '''
                }
            }
        }
    }

    post {
        always {
            deleteDir()
        }
    }
}